(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function _defineProperties(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,_toPropertyKey(r.key),r)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}function _inheritsLoose(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}!function(){const t=require("../../../services/multicardService/multicardService");let e=function(e){function r(r){var o;return(o=e.call(this)||this).multicardService=new t,o.categories=[],o.isMulticard=!0,o.productsData=new Map,o.parentId=r,o.positionManager=new i,o}_inheritsLoose(r,e);var o=r.prototype;return o.init=function(){return this},o.destroy=function(){return $.observable(this).setProperty({categories:[]}),this},o.abortRequest=function(){this.multicardService.abortRequest()},o.startModule=async function(t){this.positionManager.calcScrollPosition(!0)},o.tryUpdate=async function(t,e){var i,r,o,n;const s=e.nmId;if(s==this.nmId&&(null===(i=this.categories)||void 0===i?void 0:i.length)>0)return!0;this.nmId=s,this.id=t,this.selectedNomenclature=e,null!==(r=this.multicard)&&void 0!==r&&r.nms.has(s)||(this.multicard=await this.multicardService.getMulticard(s));const a=await(null===(o=this.multicard)||void 0===o?void 0:o.getSelectedCategories(s));return $.observable(this).setProperty({categories:[]}),(null==a?void 0:a.length)>0&&($.observable(this).setProperty({categories:a}),this._sendShownStat()),(null===(n=this.categories)||void 0===n?void 0:n.length)>0},o.getNmsForOtherSellers=function(t){return this.multicard.getNmsForOtherSellers(t)},o.onProductChanged=function(t){this.positionManager.calcScrollPosition(!1)},o.onChangeDisplayMode=function(){this.positionManager.refresh()},o.multicardItemClicked=async function(t){null==t||t.preventDefault(),null==t||t.stopPropagation(),null==t||t.stopImmediatePropagation();const{data:e}=$.view(t.currentTarget);if(e.selected)return;this.positionManager.saveScrollPosition(t.currentTarget,e);const i=this.multicard.getNmByCategory(e.id);this._sendClickedStat(e),await this._updateMulticardProduct(i)},o.setFullProduct=function(t){t&&this.productsData.set(t.selectedNomenclature.nmId,t)},o._sendShownStat=function(){this.categories.forEach(t=>{this._sendWbaStat("Item_Filter_S",t.childrenGroupName)})},o._sendClickedStat=function(t){this._sendWbaStat("Item_Filter_Apl",t.groupName,t.name)},o._sendWbaStat=function(t,e,i){const r={filter_name:e,item_id:this.nmId,id_category:this.selectedNomenclature.subjectId,id_parent_category:this.selectedNomenclature.subjectParentId};i&&(r.filter_value_name=i),this.$analitic.sendEvent(t,r)},o._updateMulticardProduct=async function(t){let e=this.productsData.get(t);if(e||(e=await this.$services.productCard.loadProductCardAsync(t),this.productsData.set(t,e)),!e)return;e=JSON.parse(JSON.stringify(e));const i=window.location.hash.substring(1),r={multicardChange:!0,isDetailsLoaded:e.selectedNomenclature.isDetailsLoaded,sourceId:this.id,sourceNmId:this.nmId,anchorTarget:i,rating:e.product,...e};this.$eventBus.dispatchEvent(new CustomEvent("ProductChanged",{detail:r}))},_createClass(r,[{key:"template",get:function(){return $.templates.multicardTmpl}}]),r}(WbSpaModel),i=function(){function t(){this.containerSelector=".j-multi-params",this.listSelector=".j-multi-params-list",this.categories=new Map}var e=t.prototype;return e.calcScrollPosition=function(t){"d"!=wb.settings.displayMode&&(t&&(this.categories=new Map),this.categories=this._toCategories(),this.categories.forEach(e=>{t?this._scrollIntoView(e):this._calcScrollPosition(e)}))},e.saveScrollPosition=function(t){var e;if("d"==wb.settings.displayMode)return;const i=t.closest(this.containerSelector),r=i.dataset.categoryId,o=this.categories.get(r);if(!o)return;const n=(null===(e=i.querySelectorAll("li"))||void 0===e?void 0:e[0]).getBoundingClientRect();o.position=-n.left},e.refresh=function(){this.categories=new Map},e._toCategories=function(){const t=document.querySelectorAll(this.containerSelector);if(!t)return null;const e=this.categories;return[...t].reduce((t,i)=>{const r=i.dataset.categoryId,o=e.get(r)||null,n={elementDOM:i,position:null==o?void 0:o.position};return t.set(r,n)},new Map)},e._scrollIntoView=function(t){var e;const i=null===(e=t.elementDOM.querySelector("button.active"))||void 0===e?void 0:e.closest("li");null==i||i.scrollIntoView()},e._calcScrollPosition=function(t){const e=t.position;e&&t.elementDOM.querySelector(this.listSelector).scrollTo(e,0)},t}();module.exports=e}();

},{"../../../services/multicardService/multicardService":4}],2:[function(require,module,exports){
"use strict";!function(){const t=require("./multicardModule");let e=function(){function e(t,e,i,n,o){this.id=t,this.selectedNomenclature=e,this.nmId=e.nmId,this.targetInfo=n,this.product=i,this.isPopup=o,this.onColorChanged=this.onColorChanged.bind(this),this.onProductChanged=this.onProductChanged.bind(this),this._initTask=this._init(),this.productChanging=Promise.resolve(),this.nmForChange=this.nmId}var i=e.prototype;return i.getNmsForOtherSellers=async function(t){var e;return this.inited?this.nmForChange==t&&await this.productChanging:await this._initTask,null!==(e=this.module)&&void 0!==e&&e.isMulticard?this.module.getNmsForOtherSellers(t):[]},i.isMulticard=function(){var t,e;return null!==(t=null===(e=this.module)||void 0===e?void 0:e.isMulticard)&&void 0!==t&&t},i.init=async function(){return this._bindEvents(),this._initTask},i._init=async function(){var t;const e=await this._getModuleWithAbort(this.id,this.selectedNomenclature,this.product,this.targetInfo,this.isPopup);$.observable(this).setProperty({module:e}),null===(t=this.module)||void 0===t||t.startModule(this.nmId),this.inited=!0},i.stopRender=function(t){var e,i;null===(e=this.abortController)||void 0===e||e.abort(),null===(i=this.multicardModel)||void 0===i||i.abortRequest()},i.destroy=function(){var t;return this._unbindEvents(),null===(t=this.module)||void 0===t?void 0:t.destroy()},i._bindEvents=function(){var t;this.$eventBus.addEventListener("ProductColorChanged",this.onColorChanged),this.$eventBus.addEventListener("ProductChanged",this.onProductChanged),null===(t=wb.displayModeSettings)||void 0===t||t.addObserver(this._onChangeDisplayMode)},i._unbindEvents=function(){var t;this.$eventBus.removeEventListener("ProductColorChanged",this.onColorChanged),this.$eventBus.removeEventListener("ProductChanged",this.onProductChanged),null===(t=wb.displayModeSettings)||void 0===t||t.removeObserver(this._onChangeDisplayMode)},i.onColorChanged=async function(t){var e,i,n;const o=new this.$helper.Deferred,{sourceId:s,sourceNmId:d,selectedNomenclature:r}=t.detail;null!==(e=this.module)&&void 0!==e&&e.isMulticard||!this._checkIsOurEvent(s,d)||(null===(i=(n=this.module).onColorChanged)||void 0===i||i.call(n,t),this.nmId=r.nmId,this.selectedNomenclature=r,o.resolve())},i.onProductChanged=async function(t){const{sourceId:e,sourceNmId:i,product:n,selectedNomenclature:o,targetInfo:s}=t.detail;if(!this._checkIsOurEvent(e,i))return;this.selectedNomenclature=o,this.nmId=o.nmId,this.targetInfo=s,this.product=n,this.stopRender(o.nmId);const d=new this.$helper.Deferred;this.nmForChange=o.nmId,this.productChanging=d.promise;const r=await this._getModuleWithAbort(e,o,n,s,this.isPopup);var l,u;this.moduleChanged?this._changeModule(r):null===(l=this.module)||void 0===l||null===(u=l.onProductChanged)||void 0===u||u.call(l,t);d.resolve()},i.onChangeDisplayMode=function(){var t;(null===(t=this.module)||void 0===t?void 0:t.isMulticard)&&this.module.onChangeDisplayMode()},i.multicardItemClicked=async function(t){var e;return null!==(e=this.module)&&void 0!==e&&e.isMulticard?this.module.multicardItemClicked(t):Promise.resolve()},i._changeModule=async function(t){var e;null===(e=this.module)||void 0===e||e.destroy(),$.observable(this).setProperty({module:null}),$.observable(this).setProperty({module:t}),this.module.startModule(this.nmId)},i._checkIsOurEvent=function(t,e){return this.id==t&&this.nmId==e},i._checkMulticardEnable=async function(e,i,n,o,s){var d,r,l;return!(null===(d=wb.global.settings.switches)||void 0===d||!d.multicardEnable||n&&!n.canCheckForMulti)&&(this.multicardModel||(this.multicardModel=new t(this.id)),null!==(r=null===(l=this.multicardModel)||void 0===l?void 0:l.tryUpdate(e,i,n,o,s))&&void 0!==r&&r)},i._checkNeedChangeModule=function(t){return!this.module||(this.module.isMulticard?!t:this.module.isMulticard?void 0:t)},i._getModuleWithAbort=async function(t,e,i,n,o){return this.abortController=new AbortController,new Promise((s,d)=>(this.abortController.signal.addEventListener("abort",t=>d(t)),this._getModule(t,e,i,n,o).then(s))).catch(t=>{})},i._getModule=async function(t,e,i,n,o){var s,d;this.moduleChanged=!1;const r=await this._checkMulticardEnable(t,e,i,n,o);if(null!==(s=this.abortController.signal)&&void 0!==s&&s.aborted)return null;if(!this._checkNeedChangeModule(r))return this.module;let l=null;if(r)l=this.multicardModel;else{l=new(await this.$moduleLoader.loadModuleAsync("productCardColors"))(t,e,i,n,o).init()}return null!==(d=this.abortController.signal)&&void 0!==d&&d.aborted?null:(this.moduleChanged=!0,l)},i.saveCurrentFullProduct=function(t){var e;null!==(e=this.module)&&void 0!==e&&e.isMulticard&&this.module.setFullProduct(t)},e}();window.__spaModuleManager__.register("productSelectionManager",e)}();

},{"./multicardModule":1}],3:[function(require,module,exports){
"use strict";!function(){let e=function(){function e(e,n){this.mainNmId=n,this.categories=e,this.nms=this._getNms(this.categories),this.products=[],this.disabledNms=[]}var n=e.prototype;return n.getNms=function(){return this.categories.reduce((e,n)=>{var t;return(null===(t=n.nms)||void 0===t?void 0:t.length)>0&&(n.nms=n.nms.slice(0,30),n.nms.forEach(n=>e.push(n))),e},[])},n.setProducts=function(e){this.products=e},n.processing=function(){const e=new Map,n=[];this.products.forEach(t=>{e.set(t.nmId,t),n.push(t.nmId)});const t=this.categories;!function i(s){var d,l;if(s)if((null===(d=s.nms)||void 0===d?void 0:d.length)>0){const t=s.nms.filter(e=>-1!=n.indexOf(e));s.products=t.map(n=>e.get(n)),s.products.sort((e,n)=>n.sort-e.sort),s.disabled=0==t.length}else if((null===(l=s.childrenIds)||void 0===l?void 0:l.length)>0){const e=[],n=s.childrenIds.map(n=>{const s=t.get(n);return i(s),s.needDelete&&e.push(s.id),s}).filter(e=>!e.needDelete);s.children=n,e.forEach(e=>{s.childrenIds.splice(s.childrenIds.indexOf(e),1)}),s.disabled=!n.find(e=>!e.disabled)}else s.needDelete=!0}(t.get(1)),this.enabledNms=n},n.getSelectedCategories=function(e){var n;let t=this.nms.get(e),i=null===(n=t)||void 0===n?void 0:n.id,s=null;const d=[];for(;i;){var l,o;t.selected=!1,(null===(l=t.nms)||void 0===l?void 0:l.length)>0||d.push(t),null===(o=t.children)||void 0===o||o.forEach(e=>{e.selected=s&&e.id==s}),s=i,i=t.parentId,t=this.categories.has(i)?this.categories.get(i):null}return d.reverse()},n.getNmsForOtherSellers=function(e){var n;return null===(n=this.nms.get(e))||void 0===n?void 0:n.nms.filter(n=>n!=e)},n.getNmByCategory=function(e){var n,t,i,s;let d=this.categories.get(e);for(;(null===(l=d.children)||void 0===l?void 0:l.length)>0;){var l;const e=d.children.filter(e=>!!e&&!e.disabled)[0];d=null!=e?e:d.children[0]}const o=null===(n=d)||void 0===n||null===(n=n.products)||void 0===n?void 0:n.find(e=>e.nmId==this.mainNmId);return o?o.nmId:(null===(t=d)||void 0===t||null===(t=t.products)||void 0===t?void 0:t.length)>0?d.products[0].nmId:(null===(i=d)||void 0===i||null===(i=i.nms)||void 0===i?void 0:i.indexOf(this.mainNmId))>=0?this.mainNmId:null===(s=d)||void 0===s||null===(s=s.nms)||void 0===s?void 0:s[0]},n._getNms=function(e){return e.reduce((e,n)=>{var t;return(null===(t=n.nms)||void 0===t?void 0:t.length)>0&&n.nms.forEach(t=>e.set(t,n)),e},new Map)},e}();module.exports=e}();

},{}],4:[function(require,module,exports){
"use strict";!function(){const t=require("./multicard");let n=function(){function n(){}var r=n.prototype;return r.getMulticard=async function(n){const r=await this._getMulticardApiWithAbort(n);if(!r)return null;const e=new t(r,n),o=e.getNms();if(!((null==o?void 0:o.length)>1))return null;const i=await this._getProducts(o);return e.setProducts(i),e.processing(),e},r.abortRequest=function(){this.abortController.abort()},r._getProducts=async function(t){if(!((null==t?void 0:t.length)>0))return null;return await wb.xnm.getGoodsForRecommendAndCatalog(t)},r._getMulticardApiWithAbort=function(t){return this.abortController=new AbortController,new Promise((n,r)=>(this.abortController.signal.addEventListener("abort",t=>r(t)),this._getMulticardApi(t).then(n))).catch(t=>{})},r._getMulticardApi=async function(t){try{let n=await WbSpaModel.prototype.$httpClient.fetchBasicJSON(wb.helpers.url.urlMulticardStatic(t),{},{nullOnError:!0,logOff:!0,signal:this.abortController.signal,timeout:2e3});return!n||this.abortController.signal.aborted?null:this._getCategoriesFromDTO(n,t)}catch(t){return null}},r._getCategoriesFromDTO=function(t,n){var r;const e=null===(r=Object.keys(t))||void 0===r?void 0:r[0];if(!e)return null;const o=t[e],i=new Map;function l(t,r=0,e=0,o=""){var u,s,a;const c=100*r+e+1;let d=null,h=null;if((null===(u=t.nms)||void 0===u?void 0:u.length)>0)d=t.nms.reduce((t,r)=>((r*=1)===n?t.unshift(r):t.push(r),t),[]);else{if(!((null===(s=t.items)||void 0===s?void 0:s.length)>0))return null;{const n=[];if(t.items.forEach((r,e)=>{const o=l(r,c,e,t.itemsName);o&&n.push(o)}),0==n.length)return null;h=n}}const g=function(t,n,r,e,o,i,l){const u={id:t,parentId:n,name:r,groupName:e,childrenGroupName:o};return i&&(u.childrenIds=i),l&&(u.nms=l),u}(c,r,null!==(a=t.value)&&void 0!==a?a:"",o,t.itemsName,h,d);return i.set(g.id,g),g.id}return l(o),i},n}();module.exports=n}();

},{"./multicard":3}]},{},[2]);
