(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,_toPropertyKey(s.key),s)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:String(t)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var s=i.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}!function(){const e=Object.freeze({orders:"orders",chats:"chats"}),t="/orders/ordo-orders|1",i=new Map;let s=function(e){function t(){const e=new Map;Object.defineProperty(this,"innerMap",{writable:!1,configurable:!1,enumerable:!1,value:e})}var i=t.prototype;return i.add=function(e){null!=e&&e.path&&this.innerMap.set(e.path,e)},i.get=function(e,t=!0){if(this.innerMap.has(e))return this.innerMap.get(e);if(!t)return null;const i=new h({path:e,file:[],sourceType:"local"});return this.innerMap.set(e,i),i},i[e]=function(){return this.innerMap.entries()},_createClass(t,[{key:"empty",get:function(){return 0==this.innerMap.size}},{key:"length",get:function(){return this.innerMap.size}},{key:"files",get:function(){return[...this.innerMap.values()]}}]),t}(Symbol.iterator),r=function(e){function t(t){var i;if(i=e.call(this)||this,Object.defineProperty(_assertThisInitialized(i),"failedFiles",{writable:!1,configurable:!1,enumerable:!1,value:new Set}),(null==t?void 0:t.length)>0)for(const e of t)i.add(e);return i}return _inheritsLoose(t,e),t.prototype.add=function({path:e,file:t,modify_time:i}){try{const s=JSON.parse(wb.utils.base64.decode(t));this.innerMap.set(e,new h({path:e,file:s,modify_time:i,sourceType:"remoteRead"}))}catch(t){console.error(t),this.failedFiles.add(e)}},t}(s),o=function(e){function t({userStorageService:t}){var i;return(i=e.call(this)||this).userStorageService=t,i}_inheritsLoose(t,e);var i=t.prototype;return i.add=function({path:e,file:t,modify_time:i}){try{const s=wb.utils.base64.encode(JSON.stringify(t));this.innerMap.set(e,new h({path:e,file:s,modify_time:i,sourceType:"remoteWrite"}))}catch(e){console.error(e)}},i.write=async function(){return this.empty?{success:!0}:await this.userStorageService.setData([...this.innerMap.values()])},t}(s),n=function(){function t({ctx:e,dbName:t,tableName:i,version:r,localOnly:o,path:n,logName:a}){this._tableName=i,this._dbName=t,this._localFilesReader=new s,this._dbSupport=!!window.indexedDB,this._version=r,this.localOnly=o,this._ctx=e,this.onlyPath=n,this.logName=a}var n=t.prototype;return n.create=async function(){if(this._localFilesReader=new s,this._dbSupport)try{this.db=i.get(this._dbName),this.db||(this.db=await this._ctx.$storageHelper.openDb(this._dbName,{version:this._version,onupgradeneeded:t=>{t.objectStoreNames.contains(" orders")&&t.deleteObjectStore(" orders");for(const i of Object.values(e))t.objectStoreNames.contains(i)||t.createObjectStore(i,{keyPath:"path"})}}),i.set(this._dbName,this.db));const t=[];if(this.onlyPath){const e=await this._ctx.$storageHelper.getItem(this.db,this._tableName,this.onlyPath);e&&t.push(e)}else{const e=await this._ctx.$storageHelper.getAll(this.db,this._tableName);t.push(...e)}for(const e of t)this._localFilesReader.add(new h(Object.assign({sourceType:"local"},e)));window._debug&&console.debug(this.logName,t.length,"file(s) read from indexedDB"),this._dbSupport=!0}catch(e){this._dbSupport=!1,console.error(e)}else window._debug&&console.debug(this.logName,"indexedDB creating failed")},n.getRemotePaths=async function({fetchOptions:e,path:t}={}){const i=window._debug&&performance.now();let s=await this._ctx.$services.apiUserStorage.getList("/"+this._tableName,e);if(!s)return console.warn(this.logName,"failed to get server paths"),new Map;window._debug&&console.debug(this.logName,s.length,"list(s) read from server","for",performance.now()-i,"ms"),t&&(s=s.filter(e=>e.path==t));const r=[];for(const{path:t}of s.filter(e=>e.is_dir)){const i=this._ctx.$services.apiUserStorage.getList(t,e).then(e=>{(null==e?void 0:e.length)>0&&s.push(...e)}).catch(e=>console.error(e));r.push(i)}await Promise.all(r);const o=new Map;for(const e of s)e.is_dir||o.set(e.path,e);return o},n.startMerge=async function(e){if(this.mergeStarted)return{success:!0};this.mergeStarted=!0;const t=await this.mergeToServer(e);return setTimeout(this._serverMergeJob.bind(this,e),3e4),t},n.toggleMergeStop=function(e){this.stopMerge=e,window._debug&&console.debug(this.logName,"merge state ",e)},n._serverMergeJob=async function(e){if(!this._remoteSyncStarted)for(this._remoteSyncStarted=!0;;)this.mergeToServer(e),await c(3e4)},n._getTimeout=function(e){const t=new AbortController;return setTimeout(()=>t.abort(),e),t.signal},n.mergeToServer=async function({path:e}={}){window._debug&&console.debug(this.logName,"Start server merging...");try{if(this.stopMerge)return;const t=2e3;let i=window._debug&&performance.now();const s=()=>({signal:this._getTimeout(t)}),n=await this.getRemotePaths({path:e,fetchOptions:s()}),a=new o({userStorageService:this._ctx.$services.apiUserStorage}),c=[],l=new Map;for(const[e,t]of this._localFilesReader)t.dirty&&(n.has(e)?(c.push({path:e}),n.delete(e)):(a.add(t),t.dirty=!1,t.modify_time=Math.round(Date.now()/1e3)+5,l.set(e,t)));if(n.size>0)for(const{path:e,modify_time:t}of n.values()){const i=this._localFilesReader.get(e,!1);(!i||i.modify_time<t||i.dirty)&&c.push({path:e})}if(c.length>0){const e=await this._ctx.$services.apiUserStorage.getData(c,s());window._debug&&console.debug(this.logName,e.length,"file(s) read from server","for",performance.now()-i,"ms");const t=new r(e);for(const[e,i]of t){const t=this._localFilesReader.get(e,!1);t?(t.mergeFrom({...i}),i.mergeFrom({...t}),t.dirty=!1,i.modified()&&a.add(i),l.set(e,t)):(this._localFilesReader.add(i),l.set(e,i))}for(const e of t.failedFiles){const t=this._localFilesReader.get(e,!1)||{path:e,file:[]};a.add(t)}}if(!a.empty){const{success:e}=await a.write();e&&window._debug&&console.debug(this.logName,"synced",a.length,"server file(s)","for",performance.now()-i,"ms")}if(l.size>0){const e=this._dbSupport?this.db.transaction(this._tableName,"readwrite").objectStore(this._tableName):null;if(e)for(const[t,i]of l)e.put(i)}}catch(e){console.error(this.logName,"sync to server error",e)}},n.syncToServer=async function(e){if(0==(e=[].concat(e)).length)return{success:!0};let t;if(this._dbSupport)try{t=this.db.transaction(this._tableName,"readwrite").objectStore(this._tableName)}catch(e){console.log(e)}const i=Math.round(Date.now()/1e3);for(const{path:r,file:o,modify_time:n}of e){const e=new h({file:o,path:r,modify_time:n||i,dirty:!0});this._localFilesReader.add(e);try{var s;null===(s=t)||void 0===s||s.put(e)}catch(e){console.error(e)}}return{success:!0}},_createClass(t,[{key:"filesReader",get:function(){return this._localFilesReader}}]),t}(),a=function(){function e(e,t,{localOnly:i}={}){this.dbName=e,this.tableName=t,this.localOnly=i,this.logName=`[${t.toUpperCase()} STORAGE SYNC]:`}var t=e.prototype;return t._initLocalStorage=function({path:e}={}){if(this._creatingTask)return this._creatingTask;const t=this.ctx.$user.getId();return window._debug&&console.debug(this.logName,"initalizing"),this.localFileStorage=new n({ctx:this.ctx,dbName:`${this.dbName}_${t||wb.helpers.generateGuid()}`,tableName:this.tableName,version:3,path:e,localOnly:!this.ctx.$router.userIsAuth||this.localOnly,logName:this.logName}),this._creatingTask=this.localFileStorage.create(),this._creatingTask},t.getFiles=async function({localOnly:e,path:t,reader:i=!1}={}){await this._initLocalStorage({path:t});let s=!1;return!0!==(!this.ctx.$router.userIsAuth||this.localOnly||e)&&(await this.localFileStorage.startMerge({path:t}),s=!0),window._debug&&console.debug(this.logName,this.localFileStorage.filesReader.files.length,`file(s) get from memory${s?" with server merge":""}`),i?this.localFileStorage.filesReader:this.localFileStorage.filesReader.files},t.toggleMergeStop=function(e){var t;null===(t=this.localFileStorage)||void 0===t||t.toggleMergeStop(e)},e}();const c=e=>new Promise(t=>setTimeout(t,e)),l=Object.freeze({chatList:"/chats/list",chatMaxSeen:"/chats/maxSeen",chat:e=>`/chats/chat/${e}`});let h=function(){function e({path:e,file:t,modify_time:i,dirty:s,sourceType:r}){this.path=e,this.file=t,s&&(this.dirty=!0),i>=0&&(this.modify_time=i);const o=new Map;Object.defineProperty(this,"_foundLookup",{enumerable:!1,configurable:!1,writable:!1,value:o}),Object.defineProperty(this,"_modified",{enumerable:!1,configurable:!1,writable:!0}),r&&Object.defineProperty(this,"sourceType",{enumerable:!1,configurable:!1,writable:!1,value:r})}var i=e.prototype;return i.mergeFrom=function(e){e.modify_time>0&&(e.modify_time>this.modify_time||!this.modify_time)&&(this.modify_time=e.modify_time),this.path==l.chatMaxSeen?this._merge(e.file,{lookup:e=>e.chatID,hasConflict:(e,t)=>e.ts>t.ts}):this.path==l.chatList?this._merge(e.file,{lookup:e=>e.chatID,hasConflict:(e,t)=>!t.senderName&&e.senderName!=t.senderName}):this.path.startsWith("/chats/chat/")?this._merge(e.file,{lookup:e=>{var t;return{ts:e.clientCreatedAt,inbox:"seller"==(null===(t=e.sender)||void 0===t||null===(t=t.seller)||void 0===t?void 0:t.type)}}}):this.path==t&&("local"==this.sourceType?this._merge(e.file,{lookup:e=>({uid:e.uid})}):"remoteRead"==this.sourceType&&(this._replace(e),this.modify_time=Math.round(Date.now()/1e3)+5))},i.update=function(e,t){this.path==l.chatMaxSeen?this._update(e,"chatID",(e,t)=>e.ts>t.ts):this.path==l.chatList?this._update(e,"chatID",(e,t)=>!t.senderName&&e.senderName!=t.senderName):t&&this.path==l.chat(t)&&this._merge(e,{lookup:e=>{var t;return{ts:e.clientCreatedAt,inbox:"seller"==(null===(t=e.sender)||void 0===t||null===(t=t.seller)||void 0===t?void 0:t.type)}}})},i.modified=function(){return 0!=this.file.length&&this._modified},i._replace=function(e){this.file=e.file,this._modified=!0},i._update=function(e,t,i=((e,t)=>e!=t)){const s=this._findItem(e[t],t);s?i(e,s)&&(Object.assign(s,e),this._modified=!0):(this._modified=!0,this.file.push(e))},i._merge=function(e,{lookup:t=(e=>({})),hasConflict:i=((e,t)=>!1)}){const s=new Map;for(const e of this.file){const i=JSON.stringify(t(e));s.set(i,e)}for(const r of e){const e=JSON.stringify(t(r));if(s.has(e)){const t=s.get(e);i(r,t)&&(Object.assign(t,r),this._modified=!0)}else this.file.push(r),this._modified=!0}},i._findItem=function(e,t){if(this._foundLookup.has(e))return this._foundLookup.get(e);for(const i of this.file)if(this._foundLookup.set(i[t],i),i[t]==e)return i;return null},e}(),u=function(t){function i({ctx:s}){var r;return(r=t.call(this,"files",e.chats)||this).ctx=s,i.instance?(i._instance=_assertThisInitialized(r))||_assertThisInitialized(r):(i.instance=_assertThisInitialized(r),r.newChats=new Map,r.newEvents=new Map,r.maxSeens=new Map,r._syncJob(),r)}_inheritsLoose(i,t);var s=i.prototype;return s._filterChatPath=function({path:e}){return e!=l.chatList&&e!=l.chatMaxSeen},s._syncJob=async function(){for(;;){if(this.newChats.size>0||this.newEvents.size>0||this.maxSeens.size>0){const e=await this.getFiles({reader:!0}),t=[];if(this.maxSeens.size>0){const i=e.get(l.chatMaxSeen);for(const[e,t]of this.maxSeens)i.update({chatID:e,ts:t});i.modified()&&t.push(i)}if(this.newChats.size>0){const i=e.get(l.chatList);for(const[e,t]of this.newChats)i.update(t);i.modified()&&t.push(i)}if(this.newEvents.size>0)for(const[i,s]of this.newEvents){const r=e.get(l.chat(i));r.update(s,i),t.push(r)}let i=window._debug&&performance.now();const{success:s}=await this.localFileStorage.syncToServer(t)||{};window._debug&&t.length>0&&(i=performance.now()-i,console.debug("[CHATS STORAGE SYNC]:","synced",t.length,"local file(s)","for",i,"ms")),s&&(this.newChats.clear(),this.newEvents.clear(),this.maxSeens.clear())}await c(3e3)}},s.saveChats=async function(e){if(e&&0!=e.length){await this._initLocalStorage();for(const t of e)this.newChats.set(t.chatID,{senderId:t.seller.id,senderName:t.seller.name,chatID:t.chatID,sign:t.sign})}},s.saveEvents=async function(e){if(e&&0!=(e=[].concat(e)).length){await this._initLocalStorage();for(const t of e){let e=this.newEvents.get(t.chatID);e||(e=[],this.newEvents.set(t.chatID,e)),e.push(t)}}},s.updateMaxSeen=async function(e){if(e&&0!=(e=[].concat(e)).length){await this._initLocalStorage();for(const{chatID:t,chatId:i,ts:s}of e)this.maxSeens.set(t||i,s)}},s.getChats=async function({localOnly:e}={}){await this._initLocalStorage();const t=await this.getFiles({localOnly:e})||[],i={chats:[],histories:new Map,maxSeen:new Map};for(const e of t)e.path==l.chatList?i.chats.push(...e.file.map(e=>({chatID:e.chatID||e.chatId,seller:{id:e.senderId,name:e.senderName},sign:e.sign,local:!0}))):e.path==l.chatMaxSeen?e.file.reduce((e,{chatID:t,ts:i})=>(e.set(t,i),e),i.maxSeen):e.path.startsWith("/chats/chat/")&&i.histories.set(e.path.substring("/chats/chat/".length),e.file);return i},i}(a),f=function(i){function s({ctx:t}){var s;return(s=i.call(this,"files",e.orders)||this).ctx=t,s}_inheritsLoose(s,i);var r=s.prototype;return r.getFiles=async function({localOnly:e,ordoOnly:s}={}){return i.prototype.getFiles.call(this,{localOnly:e,path:s?t:null})},r.getOrders=async function(e){return(await this.getFiles(e)).map(e=>e.file)},r.saveOrder=async function(e,t=1){const i=`/orders/${this.ctx.$services.sessionService.getSession()}|${t}`;try{var s,r,o;await this._initLocalStorage();const t=this.ctx.$wbxHttpClient.jwtData;e.tracker_shard_key=null!==(s=null==t?void 0:t.shard_key)&&void 0!==s?s:"",e.user=null!==(r=null==t?void 0:t.user)&&void 0!==r?r:"";const n=null!==(o=await this.ctx.$services.apiUserStorage.getData([{path:i}]).then(e=>null!=e&&e[0].file?JSON.parse(this.ctx.$helper.base64.decode(e[0].file)):[]))&&void 0!==o?o:[];return n.push(e),await this.localFileStorage.syncToServer({path:i,file:n})}catch(e){return{success:!1,error:e}}},r.saveOrdoOrder=async function(e){try{var i;await this._initLocalStorage();const o=this.ctx.$wbxHttpClient.jwtData;for(const t of e){var s,r;t.tracker_shard_key||(t.tracker_shard_key=null!==(s=null==o?void 0:o.shard_key)&&void 0!==s?s:""),t.user||(t.user=null!==(r=null==o?void 0:o.user)&&void 0!==r?r:"")}const n=null!==(i=await this.ctx.$services.apiUserStorage.getData([{path:t}]).then(e=>null!=e&&e[0].file?JSON.parse(wb.utils.base64.decode(e[0].file)):[]))&&void 0!==i?i:[];return n.push(...e),await this.localFileStorage.syncToServer({path:t,file:n})}catch(e){return console.error("Deliveries Sync error",e),{success:!1,error:e}}},r.replaceOrdoOrders=async function(e){if(!e)return{success:!1};try{return await this._initLocalStorage({path:t}),await this.localFileStorage.syncToServer({path:t,file:e})}catch(e){return{success:!1,error:e}}},r.removeFile=function(e){this.ctx.$services.apiUserStorage.setData([{path:e,file:this.ctx.$helper.base64.encode(JSON.stringify([]))}])},r.fixFile=async function(e=1){const i=t;try{var s;const e=null!==(s=await this.ctx.$services.apiUserStorage.getData([{path:i}]).then(e=>null!=e&&e[0].file?JSON.parse(this.ctx.$helper.base64.decode(e[0].file)):[]))&&void 0!==s?s:[];if(null==e||0==e.length)return;for(const t of e)if(t.delivery=Object.assign({city:"",country:"",email:"",first_name:"",phone:"",region:"",surname:"",zip:""},t.delivery),t.items)for(const e of t.items)e.hasOwnProperty("sale")||(e.sale=0);const t=await this.ctx.$services.apiUserStorage.setData([{path:i,file:this.ctx.$helper.base64.encode(JSON.stringify(e))}]);console.log(t)}catch(e){console.error(e)}},s}(a);window.__spaServiceManager__.register("storageService",function e(){if(e._singleton)return e._singleton;e._singleton=this,this.orders=new f({ctx:this}),this.chats=new u({ctx:this})})}();

},{}]},{},[1]);
