(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";const CACHE_KEY="product_feedbacks_{0}",CACHE_DURATION=12e4;let ServiceCache=function(){function e(){}var t=e.prototype;return t.saveFeedbacksModelToCache=function(e,t){sessionStorage.putObject(String.format(CACHE_KEY,e),{model:t,expiredAt:Date.now()+12e4})},t.dropFromCache=function(e){sessionStorage.removeItem(String.format(CACHE_KEY,e))},t.tryGetFromCache=function(e){try{let t=null;const o=sessionStorage.getObject(String.format(CACHE_KEY,e));return(null==o?void 0:o.expiredAt)>=Date.now()&&(t=o.model),t}catch(e){return null}},e}();module.exports=ServiceCache;

},{}],2:[function(require,module,exports){
"use strict";function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}const LEGACY_DATABASE_NAME="wb_feedbacks",DATABASE_NAME="wb_feedbacks_v1",FEEDBACK_SUMMARY_TABLE="wb_feedbacks_summary",FEEDBACKS_TABLE="wb_feedbacks",DATABASE_VERSION=1,CACHE_DURATION=9e5,FEEDBACKS_TABLE_COUNT=3,DATE_INDEX_NAME="createDt",VALUATION_INDEX_NAME="productValuation",RATE_INDEX_NAME="votesBalance";let StaticCache=function(e){function t(){var t;return(t=e.call(this)||this).interval=t._startBackgroundTask(),t}_inheritsLoose(t,e);var a=t.prototype;return a.getSummary=async function(e,t,a){const s=await this._openDb(),o=await this.$storageHelper.getItem(s,"wb_feedbacks_summary",e);if(null==o||o.ttl<Date.now())return null;const r=await this._openFeedbacksDb(o.tableId),n=await this._loadFeedbacks(r,a);return o.feedbacks=n,o.votes=this._collectUserVotes(o.votes,t),o},a.getFeedbacks=async function(e,t){const a=await this._openDb(),s=await this.$storageHelper.getItem(a,"wb_feedbacks_summary",e);if(null==s)return null;const o=await this._openFeedbacksDb(s.tableId),r=await this._loadFeedbacks(o,t);return null!=r?r:[]},a.saveFeedbacks=async function(e,t){const a=await this._openDb(),{feedbacks:s,...o}=e,r=Date.now()+9e5,n=await this.$storageHelper.getAll(a,"wb_feedbacks_summary");if(n.length>=3){n.sort((e,t)=>t.ttl-e.ttl);const e=[];for(;n.length>=3;)e.push(this.$storageHelper.removeDb(n[0].tableId)),e.push(this.$storageHelper.removeItem(a,"wb_feedbacks_summary",n[0].id)),n.pop();await Promise.all(e)}const c=`feedbacks-${t}`;a.transaction(["wb_feedbacks_summary"],"readwrite").objectStore("wb_feedbacks_summary").put({ttl:r,tableId:c,id:t,...o});const i=(await this._openFeedbacksDb(c)).transaction(["wb_feedbacks"],"readwrite").objectStore("wb_feedbacks");s.forEach(e=>i.put(e))},a.updateVote=async function(e,t,a,s){const o=await this._openDb(),r=await this.$storageHelper.getItem(o,"wb_feedbacks_summary",e);if(null===r)return;const n={id:t,vote:a>0?"plus":"minus"},c=String.format("wb_feedbacks",r.tableId),i=o.transaction(["wb_feedbacks_summary",c],"readwrite");r.votes[s]?r.votes[s].push(n):r.votes[s]=[n],i.objectStore("wb_feedbacks_summary").put(r);const u=await this.$storageHelper.getItem(o,c,t);u.votes||(u.votes={pluses:0,minuses:0}),a>0?u.votes.pluses++:u.votes.minuses++,u.votesBalance=u.rank,await this.$storageHelper.setItem(o,c,u)},a._openDb=async function(){try{return await this.$storageHelper.openDb(DATABASE_NAME,{onupgradeneeded(e){indexedDB.deleteDatabase("wb_feedbacks"),e.createObjectStore("wb_feedbacks_summary",{keyPath:"id"}).createIndex("ttl","ttl",{unique:!1})},version:1})}catch(e){return null}},a._openFeedbacksDb=async function(e){return await this.$storageHelper.openDb(e,{onupgradeneeded(e){const t=e.createObjectStore("wb_feedbacks",{keyPath:"id"});t.createIndex("createDt","createDt",{unique:!1}),t.createIndex("votesBalance","votesBalance",{unique:!1}),t.createIndex("productValuation","productValuation",{unique:!1})},version:1})},a._loadFeedbacks=function(e,t){return new Promise(a=>{var s,o;const r=[],n=e.transaction(["wb_feedbacks"],"readwrite"),{indexName:c,cursorQuery:i,direction:u}=this._getSearchParams(t),d=null!==(s=null===(o=t.productValuation)||void 0===o?void 0:o.toHashSet())&&void 0!==s?s:new Set,b=n.objectStore("wb_feedbacks").index(c);let l=0,_=0;b.openCursor(i,u).onsuccess=(e=>{const s=e.target.result,o=null==s?void 0:s.value;return s&&_!=t.take?(Array.isArray(o.photos)&&0!=o.photos.length||""!=o.text)&&(!t.hasPhoto||Array.isArray(o.photos)&&0!=o.photos.length)?d.size>0&&!d.has(o.productValuation)?s.continue():l<t.skip?(l++,s.continue()):(r.push(s.value),_++,void s.continue()):s.continue():a(r)})})},a._getSearchParams=function(e){let t,a,s;switch(e.order){case"dateAsc":t="createDt",a=IDBKeyRange.bound(-1/0,1/0),s="next";break;case"valuationDesc":t="productValuation",a=IDBKeyRange.bound(0,5),s="prev";break;case"valuationAsc":t="productValuation",a=IDBKeyRange.bound(0,5),s="next";break;case"rankDesc":t="votesBalance",a=IDBKeyRange.bound(-1/0,1/0),s="prev";break;case"rankAsc":t="votesBalance",a=IDBKeyRange.bound(-1/0,1/0),s="next";break;default:t="createDt",a=IDBKeyRange.bound(-1/0,1/0),s="prev"}return{indexName:t,cursorQuery:a,direction:s}},a._collectUserVotes=function(e,t){return e[t]?e[t].reduce((e,t)=>(e[t.id]=t.vote,e),{}):{}},a._startBackgroundTask=function(){return this._removeOutDateCache(),setInterval(this._removeOutDateCache.bind(this),6e4)},a._removeOutDateCache=async function(){const e=(await this._openDb()).transaction(["wb_feedbacks_summary"],"readwrite").objectStore("wb_feedbacks_summary");e.index("ttl").openCursor(IDBKeyRange.upperBound(Date.now())).onsuccess=(t=>{const a=t.target.result;a&&(e.delete(a.value.id),this.$storageHelper.removeDb(a.value.tableId),a.continue())})},t}(WbSpaModel);module.exports=StaticCache;

},{}],3:[function(require,module,exports){
"use strict";let FeedbacksAdapter=function(){function t(){}return t.fromStatic=function(t){if(!t)return{summary:t,votes:{}};const e={};let{valuationDistribution:a,valuationDistributionPercent:n,feedbackCount:i,feedbackCountWithText:r,valuation:o,matchingSizePercentages:u,feedbacks:s}=t;o=parseFloat(o).toFixed(1),s=this.feedbacksFromStatic(s,e);const c=u;return a=!a||i<1?null:Array.from({length:5},(t,e)=>5-e).map(t=>{var e;return{valuation:t,share:null!==(e=null==n?void 0:n[t])&&void 0!==e?e:Math.round(100*a[t]/i),count:a[t]}}),{...t,valuation:o,feedbacks:s,matchingSizeDistribution:c,valuationDistribution:a,votes:e}},t.feedbacksFromStatic=function(t,e){return Array.isArray(t)?t.map(t=>{var a;return null===(a=t.feedbackHelpfulness)||void 0===a||a.forEach(a=>{e[a.wbUserId]?e[a.wbUserId].push({id:t.id,vote:a.helpfulness}):e[a.wbUserId]=[{id:t.id,vote:a.helpfulness}]}),{createDt:new Date(t.createdDate).getTime(),votesBalance:t.rank,...t}}):[]},t.fromService=function(t){if(!t)return t;const{valuationDistribution:e,feedbackCount:a}=t;return t.valuationDistribution=!e||a<1?null:Object.entries(e).map(([t,e])=>({valuation:parseInt(t),share:e,count:Math.round(e*a/100)})).sort((t,e)=>e.valuation-t.valuation),t},t}();module.exports=FeedbacksAdapter;

},{}],4:[function(require,module,exports){
"use strict";let HashProvider=function(){function r(){}return r.numToUint8Array=function(r){const t=new Uint8Array(8);for(let n=0;n<8;n++)t[n]=r%256,r=Math.floor(r/256);return t},r.crc16Arc=function(r){const t=this.numToUint8Array(r);let n=0;for(let r=0;r<t.length;r++){n^=t[r];for(let r=0;r<8;r++)(1&n)>0?n=n>>1^40961:n>>=1}return n},r}();module.exports=HashProvider;

},{}],5:[function(require,module,exports){
"use strict";function _defineProperties(e,r){for(var t=0;t<r.length;t++){var i=r[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var r=_toPrimitive(e,"string");return"symbol"==typeof r?r:String(r)}function _toPrimitive(e,r){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var i=t.call(e,r||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)}!function(){const e=require("./providers/feedbacksServiceProvider"),r=require("./providers/feedbacksStaticProvider");let t=function(){function t(){}var i=t.prototype;return i.loadSummaryAndVotes=async function(e,r,t,i){return this.provider.loadSummaryAndVotes(e,r,t,i)},i.loadFeedbacksAsync=async function(e,r){return this.provider.loadFeedbacksAsync(e,r)},i.saveFeedbacksModelToCache=function(e,r){var t,i;null===(t=(i=this.provider).saveFeedbacksModelToCache)||void 0===t||t.call(i,e,r)},i.voteUpdate=function(e,r,t){this.provider.voteUpdate(e,r,t)},i.dropFromCache=function(e){var r,t;null===(r=(t=this.provider).dropFromCache)||void 0===r||r.call(t,e)},_createClass(t,[{key:"provider",get:function(){var t;return null!==(t=wb.global.settings)&&void 0!==t&&t.switches.enableStaticFeedbacks?r:e}}]),t}();window.__spaServiceManager__.register("productFeedbacksService",t)}();

},{"./providers/feedbacksServiceProvider":6,"./providers/feedbacksStaticProvider":7}],6:[function(require,module,exports){
"use strict";function _defineProperties(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:String(t)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var o=r.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}const FeedbacksAdapter=require("../helpers/feedbacksAdapter"),Cache=require("../cache/serviceCache"),API_URL="https://public-feedbacks.wildberries.ru/api/v1",API_URL_V2="https://feedbacks.wildberries.ru/api/v1";let FeedbacksServiceProvider=function(e){function t(){var t;return(t=e.call(this)||this).cache=new Cache,t}_inheritsLoose(t,e);var r=t.prototype;return r.loadSummaryAndVotes=async function(e,t,r){const o=this.cache.tryGetFromCache(e);if(o)return o;const[i,n]=await Promise.all([this.loadSummaryAsync(e,t,r),this.loadVotesAsync(e)]);return{summary:i,votes:n}},r.loadSummaryAsync=async function(e,t,r){try{const t=await this.$httpClient.fetchJSON(`${this.apiUrl}/summary/full`,{method:"POST",body:JSON.stringify({imtId:e,take:r,skip:0}),headers:{"Content-Type":"applicatopn/json","X-Service-Name":"site"},credentials:"omit"},{noProcessResponse:!0,timeout:5e3});return FeedbacksAdapter.fromService(t)}catch(e){return console.error(e),{feedbackCount:0}}},r.loadVotesAsync=async function(e){try{var t;const{votes:r}=null!==(t=await this.$httpClient.fetchExt(`${this.apiUrl}/votes?imtId=${e}`,{headers:{"Content-Type":"applicatopn/json","X-Service-Name":"site"},credentials:"omit"},{timeout:3e3}).then(e=>e.json()))&&void 0!==t?t:{};return null!=r?r:{}}catch(e){return e&&console.error(e),{}}},r.loadFeedbacksAsync=async function(e,t){try{var r;const{feedbacks:o}=null!==(r=await this.$httpClient.fetchJSON(`${this.apiUrl}/feedbacks/site`,{method:"POST",body:JSON.stringify({imtId:e,...t}),headers:{"Content-Type":"applicatopn/json","X-Service-Name":"site"},credentials:"omit"},{noProcessResponse:!0}))&&void 0!==r?r:{};return null!=o?o:[]}catch(e){return console.error(e),[]}},r.voteUpdate=function(e){this.dropFromCache(e)},r.saveFeedbacksModelToCache=function(e,t){this.cache.saveFeedbacksModelToCache(e,t)},r.dropFromCache=function(e){this.cache.dropFromCache(e)},_createClass(t,[{key:"apiUrl",get:function(){var e;return null!==(e=wb.global.settings)&&void 0!==e&&e.switches.useNewPublicFeedbacks?API_URL_V2:API_URL}}]),t}(WbSpaModel);module.exports=new FeedbacksServiceProvider;

},{"../cache/serviceCache":1,"../helpers/feedbacksAdapter":3}],7:[function(require,module,exports){
"use strict";function _inheritsLoose(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}const Cache=require("../cache/staticCache"),FeedbacksAdapter=require("../helpers/feedbacksAdapter"),HashProvider=require("../helpers/hashProvider"),API_URL="https://feedbacks{0}.wb.ru";let StaticFeedbacksProvider=function(t){function e(){var e;return(e=t.call(this)||this).cache=new Cache,e}_inheritsLoose(e,t);var a=e.prototype;return a.loadSummaryAndVotes=async function(t,e,a,r=null,s=0){const{userInfo:c}=await this.$services.userData.getUserDataAsync(),o=await this.cache.getSummary(t,c.id,{order:null!=r?r:"dateDesc",take:30,skip:0});if(null!=o){const{votes:t,...e}=o;return{summary:e,votes:t}}return null==await this._loadStaticFeedbacks(t)||s>0?{summary:{feedbackCount:0},votes:{}}:this.loadSummaryAndVotes(t,e,a,r,s++)},a.loadFeedbacksAsync=async function(t,e,a=0){const r=await this.cache.getFeedbacks(t,e);return null!=r?r:null==await this._loadStaticFeedbacks(t,0)||a>0?[]:this.loadFeedbacksAsync(t,e,a++)},a.voteUpdate=async function(t,e,a){const{userInfo:r}=await this.$services.userData.getUserDataAsync();this.cache.updateVote(t,e,a,r.id)},a._prepareUrl=function(t){const e=HashProvider.crc16Arc(t);return String.format(API_URL,e%100>=50?"2":"1")},a._loadStaticFeedbacks=async function(t){const e=this._prepareUrl(t),a=await this.$analitic.isAbTest155Approved()?"v1-by-date":"v1";try{const r=await this.$httpClient.fetchBasicJSON(`${e}/feedbacks/${a}/${t}`),s=FeedbacksAdapter.fromStatic(r);return await this.cache.saveFeedbacks(s,t),s}catch(t){return null}},e}(WbSpaModel);module.exports=new StaticFeedbacksProvider;

},{"../cache/staticCache":2,"../helpers/feedbacksAdapter":3,"../helpers/hashProvider":4}]},{},[5]);
