(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";let ChatAttachment=function(){function t({ctx:t,message:e,attachment:n,messageIndex:a,attachmentIndex:o,imgCounter:i}){this.parentIndex=a,this.index=o;const{url:s,name:r,size:c}=n;this.url=s,this.name=r,this.size=c,null!=e&&e.dt&&(this.dt=e.dt),this.ctx=t,this.imgCounter=i}var e=t.prototype;return e.goToMessage=function(t,e){if(t.preventDefault(),t.stopPropagation(),Number.isInteger(this.parentIndex)){$.observable(this.ctx).setProperty({isTabsOpen:!1}),this.ctx.closeSlider();const t=this.ctx.chat.querySelector(`.chat__message:nth-last-of-type(${this.parentIndex})`);t&&t.scrollIntoView()}},e.download=function(t,e){if(t.preventDefault(),!this.url)return;window.navigator&&window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(blob,data.fileName);const n=(t,e)=>{const n=document.createElement("a");n.href=t,n.download=this.name||wb.helpers.path.fileName(this.url),n.onclick=(t=>t.stopPropagation()),n.target="_blank",document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n),e&&URL.revokeObjectURL(t)},200)};return fetch(this.url).then(async t=>{const e=await t.blob();if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,data.fileName);else{const t=URL.createObjectURL(e);n(t,!0)}}).catch(()=>n(this.url,!1)),!1},t}();module.exports=ChatAttachment;

},{}],2:[function(require,module,exports){
"use strict";const URL_REGEX=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,ChatAttachment=require("./chatAttachment");let ChatMessage=function(){function t({id:t,chatId:e,text:i="",dt:a=new Date,inbox:s=!1,attachments:n,isRatingRequest:h}){t&&(this.id=t),e&&(this.chatId=e),this.text=i,this.dt=new Date(a),this.inbox=s,n&&(this.attachments=n),h&&(this.isRatingRequest=!0)}var e=t.prototype;return e.hasFile=function(){var t;return(null===(t=this.attachments)||void 0===t||null===(t=t.files)||void 0===t?void 0:t.length)>0},e.hasImage=function(){var t;return(null===(t=this.attachments)||void 0===t||null===(t=t.images)||void 0===t?void 0:t.length)>0},e.hasUrl=function(){var t;return(null===(t=this.attachments)||void 0===t||null===(t=t.urls)||void 0===t?void 0:t.length)>0},e.images=function(t){var e;return null===(e=this.attachments)||void 0===e?void 0:e.images.map(e=>new ChatAttachment({message:this,attachment:e,imgCounter:t,attachmentIndex:t.counter++}))},e.files=function(){var t;return null===(t=this.attachments)||void 0===t?void 0:t.files.map(t=>new ChatAttachment({attachment:t}))},e.urls=function(){var t;return null===(t=this.attachments)||void 0===t?void 0:t.urls.map(t=>new ChatAttachment({attachment:t}))},e.setSender=function({id:t,name:e}){return t||e?(this.sender={id:t,name:e},this):this},e.addImage=function({url:t,name:e,size:i,type:a,date:s}){return t?(this.attachments||(this.attachments={}),this.attachments.images||(this.attachments.images=[]),this.attachments.images.push({url:t,name:e,size:i,type:a,date:s}),this):this},e.addFile=function({url:t,name:e,size:i,type:a,date:s}){return t?(this.attachments||(this.attachments={}),this.attachments.images||(this.attachments.files=[]),this.attachments.files.push({url:t,name:e,size:i,type:a,date:s}),this):this},e.tryLinkify=function(){return this.text?(this.text=this.text.replace(URL_REGEX,t=>(this.attachments||(this.attachments={}),this.attachments.urls||(this.attachments.urls=[]),this.attachments.urls.push({url:t}),"")),this):this},t.createFromWbChat=function({message_id:t,msg_text:e,image_url:i,file_url:a,dt:s,is_inside:n,employee_id:h,employee_first_name:r,message_type_id:m}={}){return new this({id:t,text:e,dt:s,inbox:n,isRatingRequest:2==m}).addFile({url:a}).addImage({url:i}).setSender({id:h,name:r}).tryLinkify()},t.createFromEvent=function(t){var e,i,a;return new this({chatId:t.chatID,text:null===(e=t.message)||void 0===e?void 0:e.text,attachments:Object.assign({},null===(i=t.message)||void 0===i?void 0:i.attachments),dt:new Date(t.addTime||t.clientCreatedAt),inbox:"seller"==(null===(a=t.sender)||void 0===a?void 0:a.type)}).tryLinkify()},t}();module.exports=ChatMessage;

},{"./chatAttachment":1}],3:[function(require,module,exports){
"use strict";const ChatMessage=require("./chatMessage"),SellersChatService=require("../../services/chat/sellersChatService"),DEFAULT_SELLER_NAME="by"==wb.settings.currentLocale?"Поставщик":"Продавец";let ChatWorker=function(){function e(e){this.chatService=new SellersChatService,this.storageService=e.$services.storageService.chats,this._longPoll=this._longPoll.bind(this),this.lastTime=0,this.chats=e.chats,this.ctx=e}var t=e.prototype;return t.start=async function(){try{const e=await this._initChats();e>=0&&this.restart(e)}catch(e){console.error(e)}},t.restart=function(e){this.stop(),this.lastTime=e,this.pollId=setTimeout(this._longPoll,100)},t.stop=function(e=!1){var t;if(null===(t=this.currentPoll)||void 0===t||t.abort(),clearTimeout(this.pollId),this.currentPoll=null,e){const e=this.chats.find(e=>e.wb);e&&($.observable(this.chats).refresh([e]),$.observable(this.ctx).setProperty({activeChat:e}))}},t.showChat=async function({chatId:e,text:t,sellerId:s,title:i,goodCard:r}={}){let a=this.chats.find(t=>t.name===e);const n=Date.now();if(i||(i=DEFAULT_SELLER_NAME),a){!(null==r||!r.rid)&&a.history.some(e=>{var t;return(null===(t=e.attachments)||void 0===t||null===(t=t.goodCard)||void 0===t?void 0:t.rid)==r.rid})||($.observable(a).setProperty({text:t}),a.goodCard=r),a.title||($.observable(a).setProperty({title:i}),"Продавец"!=i&&(a.sellerName=i,a.dirty=!0)),$.observable(a).setProperty({onTop:n})}else{const e=i;(a=await this._createNewSellerChat({sellerId:s,sellerName:e})).text=t,a.goodCard=r,a.onTop=n,$.observable(this.chats).insert(a)}this._updateSellerLogos([a])},t._initChats=async function(){let e=-1;const{serverChats:t,broken:s}=await this.chatService.getChats().then(e=>({serverChats:e})).catch(()=>({broken:!0,serverChats:[]}))||{serverChats:[]};if(0==t.length&&!s)return e;const{chats:i,histories:r,maxSeen:a}=await this.storageService.getChats();if(a.has("wb")){const e=this.chats.find(e=>e.wb);e&&(e.maxSeen=a.get(e.name))}const n=[...t.concat(i).reduce((e,t)=>(e.has(t.chatID)||e.set(t.chatID,t),e),new Map).values()];if(n.length>0){e=0;const t=[],i=[],o=new Set;let h,c=this.ctx.chat.isVisible();for(const d of n){var l;const{chatID:n,seller:v,sign:u,local:g}=d;if(o.has(n))continue;o.add(n),g||i.push(d);const m=await this._createNewSellerChat({chatId:g&&!s?null:n,sellerId:v.id,sellerName:v.name,sign:u});m.maxSeen=a.get(m.chatId)||0;const p=null===(l=r.get(n))||void 0===l?void 0:l.map(e=>{var t;return!m.sellerName&&"seller"==(null==e||null===(t=e.sender)||void 0===t?void 0:t.type)&&e.sender.name&&(m.sellerName=m.title=e.sender.name),ChatMessage.createFromEvent(e)});if((null==p?void 0:p.length)>0){for(const e of p)m.history.push(e),e.inbox&&m.maxSeen>0&&+e.dt>m.maxSeen&&(m.unreadCount=(m.unreadCount||0)+1);e=Math.max(+p[p.length-1].dt,e),c||m.unreadCount>0&&(this.ctx.$eventBus.dispatchEvent(new CustomEvent("OnlineChatShowUnread")),c=!0)}this.ctx.lastActiveChatName==m.name&&(h=m),t.push(m)}t.length>0&&($.observable(this.chats).insert(t),h&&$.observable(this.ctx).setProperty({activeChat:h}),i.length>0&&this.storageService.saveChats(i),this._updateSellerLogos(t))}return e},t._longPoll=async function(){this.currentPoll=new AbortController;try{const e=await this.chatService.getEvents({lastTime:this.lastTime,delay:50},{signal:this.currentPoll.signal});if(e){this._refreshHistory(e);for(const t of e)this.lastTime=Math.max(this.lastTime,t.addTime);this.lastTime>0&&(this.pollId=setTimeout(this._longPoll.bind(this),100))}}catch(e){"AbortError"!==e.name&&(clearTimeout(this.pollId),this.pollId=setTimeout(this._longPoll.bind(this),6e4))}},t._refreshHistory=async function(e){if(0==e.length)return;const t=[],s=e.reduce((e,s)=>{var i;const r=`${s.sender.type}_${s.sender.id}`;let a=e.get(r);if(a||((a=[]).senderId=s.sender.id,a.senderName=s.sender.name||$.localize("Продавец"),a.chatId=s.chatID,a.sign=s.sign,e.set(r,a)),"message"==s.eventType||"created"==(null===(i=s.message)||void 0===i?void 0:i.actionType)){t.push(s);const e=ChatMessage.createFromEvent(s);a.push(e)}return e},new Map);if(s.size>0){let e=[];this.storageService.saveEvents(t);for(const[t,i]of s){const s=this.chats.find(e=>e.name===t);if(s)i.length>0&&$.observable(s.history).insert(i),s.initializing&&$.observable(s,!0).removeProperty("initializing"),s.title||($.observable(s).setProperty({title:i.senderName}),s.sellerName=i.senderName,s.dirty=!0);else{const s=await this._createNewSellerChat({chatId:i.chatId,sign:i.sign});s.name=t,s.title=i.senderName,s.history=i,s.sellerId=i.senderId,s.sellerName=i.senderName,e.push(s)}}e&&$.observable(this.chats).insert(e),t.length>0&&!this.ctx.chat.isVisible()&&this.ctx.$eventBus.dispatchEvent(new CustomEvent("OnlineChatShowUnread"))}for(const e of this.chats.filter(e=>e.initializing))$.observable(e,!0).removeProperty("initializing")},t._updateSellerLogos=async function(e){await this.ctx.$moduleLoader.loadServiceAsync("suppliersService");for(const t of e)t.sellerId>0&&this.ctx.$services.suppliersService.getSupplierExtInfo(t.sellerId).then(e=>{$.observable(t).setProperty({hasLogo:e.hasLogo})})},t._createNewSellerChat=async function({chatId:e,sellerId:t,sellerName:s,sign:i}){this.SellerOnlineChat||(this.SellerOnlineChat=await this.ctx.$moduleLoader.loadModuleAsync("sellerOnlineChat"));const r=new this.SellerOnlineChat({chatService:this.chatService,storageService:this.storageService,chatId:e,sellerId:t,sellerName:s,sign:i,ctx:this.ctx});return r.init(this.ctx.chatWrapper,this.ctx.chat),r},e}();module.exports=ChatWorker;

},{"../../services/chat/sellersChatService":8,"./chatMessage":2}],4:[function(require,module,exports){
"use strict";$.fn.draggable=function(t,e){var n=this,o=$(t),i=0,c=0;function u(t){t.preventDefault(),i=t.clientX,c=t.clientY,$(document).on("mousemove",f).on("mouseup",l)}function f(t){t.preventDefault();var e=n[0].offsetTop-c+t.clientY,o=n[0].offsetLeft-i+t.clientX,u=function(t,e){var o=n[0].getBoundingClientRect(),u=document.documentElement.clientWidth||document.body.clientWidth||window.innerWidth,f=(document.documentElement.clientHeight||document.body.clientHeight||window.innerHeight,!0),l=!0;return o.top<0&&e<=c&&(f=!1),(o.left<0&&t<=i||o.right>u&&t>=i)&&(l=!1),{modifyTop:f,modifyLeft:l}}(t.clientX,t.clientY);u.modifyTop&&(n[0].style.top=e+"px"),u.modifyLeft&&(n[0].style.left=o+"px"),i=t.clientX,c=t.clientY}function l(t){t.preventDefault(),$(document).off("mousemove",f).off("mouseup",l),$.isFunction(e)&&e(n[0].style.left,n[0].style.top)}return o.on("mousedown",u),this};

},{}],5:[function(require,module,exports){
"use strict";function _defineProperties(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,s){return e&&_defineProperties(t.prototype,e),s&&_defineProperties(t,s),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(t,e){if("object"!=typeof t||null===t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var i=s.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}!function(){require("./draggable");const t=require("./chatWorker"),e=require("../../services/chat/chatStaticService"),s=Object.freeze({name:"wb",title:"Поддержка Wildberries"}),i=Object.freeze({inited:"inited",destroyed:"destroyed"});let n=function(){function n({auth:t,uid:s}){this.status=i.destroyed,this.uid=s,this.isAuth=t,this.chatWrapper=document.querySelector(".j-chat-wrap"),this._lazyCheckBounds=this.$helper.debounce(this._checkBounds.bind(this),200),this.bodyOverflowClass="body--overflow",this.widthScrollbar=Math.abs(window.innerWidth-document.documentElement.clientWidth),this.chatOverlay=this._getChatOverlay(),this._updateSettingsFromEvent=this._updateSettingsFromEvent.bind(this),this.onType=this.onType.bind(this),this._onAuthLogin=this._onAuthLogin.bind(this),this._onUnAuthLogin=this._onUnAuthLogin.bind(this),this._onToggleSellersSwitcher=this._onToggleSellersSwitcher.bind(this),this.chats=[],this.isTabsOpen=!1,this.isMessageSearchOpen=!1,this.currentTab="m",this.isSliderPopupOpened=!1,this.beginFilter=this.$helper.debounce(this.beginFilter.bind(this),500),this.filterChat=this.filterChat.bind(this),this.sortChats=this.sortChats.bind(this),this.onBreakpoint=this.onBreakpoint.bind(this),this.sortChats.depends=["chats^[]^history^length","chats^[]^onTop"],this.openSlider=this.openSlider.bind(this),this.filterChat.depends="chatPattern",this.staticData=e,$.templates("contextMenu",{markup:"<a class=\"context-menu__content j-context-content\" data-link=\"{on 'click' goToMessage}{on ~sendAnalytics 'Purchases_Chat_Attachment_Message_T'}\">Перейти к сообщению</a>",helpers:{sendAnalytics:this.sendAnalytics.bind(this)}},this.template);const n=this;$.views.tags({chatAnalytics:{baseTag:"on",init:function(t){const[e,...s]=t.args;this.eventName=e,this.props=t.props;let i="click",n=!1;t.props.customEvent&&(n=!0,i=t.props.customEvent,delete t.props.customEvent),t.args=[i,...s,this.sendAnalytics.bind(this,e,t.props),n],this.baseApply(arguments)},sendAnalytics:function(t,e,s,i,r){const o={};if(s)for(const t in i.originalEvent.detail)o[t]=i.originalEvent.detail[t];else if(e)for(const t in e)if("eventData"==t){const s=e[t],{data:n}=$.view(i.currentTarget);o[s]=n[s]}else o[t]=e[t];n.sendAnalytics(t,o)}}},this.template),$.observe(this,"chats^[]^unreadCount",(t,e)=>{0==this.chats.reduce((t,e)=>t+(e.unreadCount||0),0)?this._removeUnread():this._showUnread()})}var r=n.prototype;return r.currentChat=function(){var t;return null!==(t=this.activeChat)&&void 0!==t?t:this.chats[0]},r.changeInputHeight=function(t){if(t||(t=document.querySelector(".j-chat-textarea")),!t)return;t.style.height="auto";const e=t.scrollHeight;t.style.height=e+"px";const s=t.value.length;t.setSelectionRange(s,s),t.focus(),t.scrollTop=t.scrollHeight-t.clientHeight},r.init=function(){return document.addEventListener("click",this.$helper.delegator(".j-btn-chat-open",(t,e)=>{this._toggleChat(),this.$analitic.sendEvent(e.hasAttribute("data-header")?"Support_Chat_Header_T":"Support_Chat_T"),this.sendAnalytics("Purchases_Chat_S")})),this},r.start=function(t){return this.status==i.inited?this._refreshChatAsync():this._startChatAsync(t)},r.restart=function({auth:t,uid:e}){this.destroy(),this.isAuth=t,this.uid=e,wb.displayModeSettings.removeObserver(this.onBreakpoint),wb.displayModeSettings.addObserver(this.onBreakpoint,!0)},r.destroy=function(){var t;if(this.status!=i.destroyed){this._removeUnread(),this.status=i.destroyed,this._unbindEvents(),this.chatOverlay.hide(),document.querySelectorAll(".j-btn-chat-open").forEach(t=>{t.classList.add("hide")}),document.body.classList.remove("body--chat-overflow"),$(this.chatWrapper).unlink();for(const t of this.chats)t.stopChat();null===(t=this.chatWorker)||void 0===t||t.stop(),this.chatWorker=null,$.observable(this.chats).refresh([])}},r.minimize=function(){this._updateSetting("show",!1),this.chatOverlay.hide(),document.removeEventListener("click",this)},r.sendAnalytics=function(t,e){const s=this.currentChat();s&&!s.wb&&this.$analitic.sendEvent(t,Object.assign({supplier_id:s.sellerId,supplier:s.sellerName},e))},r.onType=function(t){const{currentType:e,isInit:s}=t.detail;if("m"==wb.settings.displayMode)return"home"!=e&&"archive"!=e&&"orders"!=e?(this.destroy(),void this.$eventBus.addEventListener("onUserAuth",this._onAuthLogin,{single:!0})):this.status==i.destroyed?this.start({ignoreShow:!s}):void 0},r.onBreakpoint=function(t){"m"===t?this._addMobileMenuHandler():(this._removeMobileMenuHandler(),this.start())},r.switchChat=function(t){const e=this.chats.find(e=>e.name===t);e&&(this.$observable.setProperty({activeChat:e,isTabsOpen:!1,isMessageSearchOpen:!1,currentTab:"m",open:!0}),e.scrollToBottom(),this.changeInputHeight(),this._resetSearch(),e.lastMessage()&&e.visit({dt:e.lastMessage().dt,observe:!0}))},r.backToChats=function(){this.$observable.setProperty({open:!1})},r.closeMediaGallery=function(){this.$observable.setProperty({isTabsOpen:!1,isSliderPopupOpened:!1})},r.toggleTabsVisible=function(t,e){t.preventDefault(),t.stopPropagation(),this.$observable.setProperty({isTabsOpen:!this.isTabsOpen})},r.toggleSearchVisible=function(t){if(t.preventDefault(),t.stopPropagation(),this.$observable.setProperty({isMessageSearchOpen:!this.isMessageSearchOpen}),this.isMessageSearchOpen){document.querySelector(".j-search-message").focus()}this.isMessageSearchOpen||this._resetSearch()},r._resetSearch=function(){const t=this.currentChat();$.observable(this).removeProperty("searchText"),$.observable(t.foundPatterns).refresh([]),$.observable(t).setProperty("searchIndex",0),$.observable(t).setProperty("searchingComplete",!1);for(const e of t.history)$.observable(e).removeProperty("foundText")},r.switchTab=function(t,e){e.preventDefault(),this.$observable.setProperty({currentTab:t})},r.openSlider=function(t,e){this.$observable.setProperty({isSliderPopupOpened:!0});const s=document.querySelector(".j-chat-thumbs");this.swiperThumbs=new Swiper(s.querySelector(".swiper-container"),{slidesPerView:8,spaceBetween:8,centerInsufficientSlides:!0,updateOnWindowResize:!0,watchOverflow:!0,watchSlidesVisibility:!0,navigation:{nextEl:s.querySelector(".swiper-button-next"),prevEl:s.querySelector(".swiper-button-prev"),lockClass:"hide"},breakpoints:{1200:{slidesPerView:10},1400:{slidesPerView:12},1600:{slidesPerView:15}}});const i=document.querySelector(".j-chat-slider"),{data:n}=$.view(t.target);let{imgCounter:r,index:o}=n;r&&(o=r.counter-1-o),this.swiper=new Swiper(i.querySelector(".swiper-container"),{slidesPerView:1,spaceBetween:16,updateOnWindowResize:!0,watchOverflow:!0,navigation:{nextEl:i.querySelector(".swiper-button-next"),prevEl:i.querySelector(".swiper-button-prev")},thumbs:{swiper:this.swiperThumbs},pagination:{el:document.querySelector(".j-chat-slide-counter"),type:"fraction",renderFraction:(t,e)=>`<span class="${t}"></span> / <span class="${e}"></span>`},initialSlide:o,keyboard:{enabled:!0,onlyInViewport:!0}});const a=$.view(this.swiper.slides[o]);null==a||a.ctxPrm("currentMessage",a.data),this.swiper.on("activeIndexChange",()=>{const t=$.view(this.swiper.slides[this.swiper.activeIndex]);t.ctxPrm("currentMessage",t.data)})},r.closeSlider=function(t){var e,s;null==t||t.stopPropagation(),null===(e=this.swiper)||void 0===e||e.destroy(),null===(s=this.swiperThumbs)||void 0===s||s.destroy(),this.$observable.setProperty({isSliderPopupOpened:!1})},r.handleEvent=function(t){("click"==t.type||this.chat.isVisible())&&(t.target.closest(".j-seller-chat")||t.target.closest(".popup-alert")||this.chatWrapper.contains(t.target)||this.minimize())},r.onGoToUrl=function(t){return wb.global.userSettings.closed.push("chat-popup"),wb.global.saveUserSettings(),!0},r._addMobileMenuHandler=function(){this.$eventBus.addEventListener("MobileMenuTypeChange",this.onType,{single:!0})},r._removeMobileMenuHandler=function(){this.$eventBus.removeEventListener("MobileMenuTypeChange",this.onType)},r._startChatAsync=async function({ignoreShow:e}={}){var s,n;const r=await this.$moduleLoader.loadModuleAsync("onlineChat");await this.$moduleLoader.loadServiceAsync("storageService");const o=new r(this.isAuth,this.uid,{ctx:this,storageService:this.$services.storageService.chats});$.observable(this.chats).insert(o),this.activeChat=o;let a=!1;for(const t of this.chats)a|=await t.initAsync();if(!a)return;this.status=i.inited,this.lastActiveChatName=null===(s=this.chatWrapper.querySelector(".chat"))||void 0===s?void 0:s.getAttribute("data-last-chat"),this.template.link(this.chatWrapper,this),this._bindEvents(),this.chat=document.querySelector(".chat");for(let t of this.chats)t.init(this.chatWrapper,this.chat);if(this.isAuth&&null!==(n=wb.global.settings)&&void 0!==n&&null!==(n=n.switches)&&void 0!==n&&n.enableSellersChat)this.chatWorker=new t(this),this.chatWorker.start();else if(o.history.length>0){const{maxSeen:t}=await this.$services.storageService.chats.getChats({localOnly:!0}),e=t.get("wb");e>0&&$.observable(o).setProperty("maxSeen",e)}let h=this._getSettings();if(h){let t;if(e||!h.show||(t=wb.global.userSettings.closed.includes("chat-popup"))||(this.chatOverlay.show(),document.addEventListener("click",this)),h.show&&(this._lazyCheckBounds(),this.currentChat().scrollToBottom()),t){const t=wb.global.userSettings.closed.indexOf("chat-popup");t>=0&&(wb.global.userSettings.closed.splice(t,1),wb.global.saveUserSettings())}}},r._getStorageService=function(){return this.$moduleLoader.loadServiceAsync("storageService")},r._refreshChatAsync=function(){var e;this.chats.find(t=>t.name===s.name).refreshAsync(),this.isAuth&&null!==(e=wb.global.settings)&&void 0!==e&&null!==(e=e.switches)&&void 0!==e&&e.enableSellersChat&&!this.chatWorker&&this._getStorageService().then(()=>{this.chatWorker=new t(this),this.chatWorker.start()})},r._getSettings=function(){var t,e;return null!==(t=null!==(e=this._tryGetSettingsFromLocalStorage())&&void 0!==e?e:this._tryGetSettingsFromCookie())&&void 0!==t?t:{}},r._tryGetSettingsFromLocalStorage=function(){return localStorage.getObject("wb_chat_settings")},r._tryGetSettingsFromCookie=function(){const t=wb.cookieHelper.getCookie("_wbchat");if(!(t&&t.length>0))return null;try{const e=JSON.parse(t);return this._saveSettings(e),e}catch(t){return null}},r._saveSettings=function(t){localStorage.putObject("wb_chat_settings",t)},r._updateSetting=function(t,e){const s=this._getSettings();s[t]=e,this._saveSettings(s)},r._updateSettingsFromEvent=function(t){const e=t.detail;if(!Array.isArray(e))return;const s=this._getSettings();e.forEach(([t,e])=>s[t]=e),this._saveSettings(s)},r._onToggleSellersSwitcher=function(e){const s=e.detail;s&&!this.chatWorker?this.isAuth&&this._getStorageService().then(()=>{this.chatWorker=new t(this),this.chatWorker.start()}):!s&&this.chatWorker&&(this.chatWorker.stop(!0),this.chatWorker=null)},r._bindEvents=function(){document.querySelectorAll(".j-btn-chat-open").forEach(t=>{t.classList.remove("hide")}),window.addEventListener("resize",this._lazyCheckBounds),window.addEventListener("scroll",this._lazyCheckBounds),this.$eventBus.addEventListener("UpdateOnlineChatSettings",this._updateSettingsFromEvent),this.$eventBus.addEventListener("OnlineChatShowUnread",this._showUnread),this.$eventBus.addEventListener("onUserAuth",this._onAuthLogin,{single:!0}),this.$eventBus.addEventListener("onUserUnAuth",this._onUnAuthLogin),this.$eventBus.addEventListener("SellersChatSwitched",this._onToggleSellersSwitcher)},r._unbindEvents=function(){window.removeEventListener("resize",this._lazyCheckBounds),window.removeEventListener("scroll",this._lazyCheckBounds),this.$eventBus.removeEventListener("UpdateOnlineChatSettings",this._updateSettingsFromEvent),this.$eventBus.removeEventListener("OnlineChatShowUnread",this._showUnread),this.$eventBus.removeEventListener("onUserAuth",this._onAuthLogin),this.$eventBus.removeEventListener("onUserUnAuth",this._onUnAuthLogin),this.$eventBus.removeEventListener("SellersChatSwitched",this._onToggleSellersSwitcher),document.removeEventListener("click",this)},r._onAuthLogin=function(){this.restart({auth:!0})},r._onUnAuthLogin=function(){this.restart({auth:!1,uid:this.$services.sessionService.getBasketUid()})},r._checkBounds=function(){let t=this.chat.getBoundingClientRect(),e=document.documentElement.clientWidth||document.body.clientWidth||window.innerWidth,s=document.documentElement.clientHeight||document.body.clientHeight||window.innerHeight;(t.top<0&&0==window.scrollY||t.top+t.height/2>s)&&(this.chat.style.top="",this._updateSetting("y",void 0)),(t.left<-10||t.right>e+10)&&(this.chat.style.left="",this._updateSetting("x",void 0))},r.showChat=async function(t){var e;await this.chatWorker.showChat(t),this._toggleChat(),this.switchChat(t.chatId,{disableStats:!0}),this.changeInputHeight(),this.sendAnalytics("Purchases_Chat_Seller_T",{id:null==t||null===(e=t.goodCard)||void 0===e?void 0:e.nmID})},r.setSearching=function(t,e){e.view.ctxPrm("searching",!0)},r.beginFilter=function(t,e){var s;const i=null===(s=t.target.value)||void 0===s?void 0:s.trim().replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");if(i&&/[\wА-Яа-я]/.test(i)){const t=new RegExp(i,"i");$.observable(this).setProperty("chatPattern",t),this.sendAnalytics("Purchases_Chat_SearchRequest_Send",{text:i})}else $.observable(this).removeProperty("chatPattern");e.view.ctxPrm("searching",!1)},r.filterChat=function(t,e,s){return!this.chatPattern||this.chatPattern.test(t.title)},r.sortChats=function(t,e){if(t.wb)return-1;if(e.wb)return 1;function s(t){return t.onTop>0?t.onTop:t.lastMessage()?+t.lastMessage().dt:0}return s(e)-s(t)},r.clearSearchChat=function(t){t.target.closest(".j-search-chat").querySelector("input").value="",$.observable(this).removeProperty("chatPattern")},r._toggleChat=function(){if(this.status==i.destroyed)return;this._toggleElem(this.chatWrapper);const t=this.chat.isVisible();return this._updateSetting("show",t),t&&(this._lazyCheckBounds(),1==this.chats.length&&this.chats[0].lastMessage()&&this.chats[0].visit({dt:this.chats[0].lastMessage().dt,observe:!0}),document.addEventListener("click",this),("d"==wb.settings.displayMode||this.open)&&this.changeInputHeight()),this.currentChat().scrollToBottom(),!1},r._toggleElem=function(t){t.isVisible()?this.chatOverlay.hide():this.chatOverlay.show()},r._showUnread=function(){document.querySelector(".smm-fixed").classList.add("isWbMessage")},r._removeUnread=function(){this._updateSetting("unread",!1),document.querySelector(".smm-fixed").classList.remove("isWbMessage")},r._getChatOverlay=function(){const t=document.body;let e;return{show:()=>{e||(t.insertAdjacentHTML("afterBegin",'<div class="overlay overlay--chat j-overlay-chat"></div>'),e=t.querySelector(".j-overlay-chat"),this.chatWrapper.classList.remove("hide"),document.body.classList.add(this.bodyOverflowClass),document.body.style.paddingRight=`${this.widthScrollbar}px`)},hide:()=>{e&&e.remove(),e=null,this.chatWrapper.classList.add("hide"),document.body.classList.remove(this.bodyOverflowClass),document.body.style.paddingRight=""}}},_createClass(n,[{key:"template",get:function(){return n.template}}]),n}();window.__spaModuleManager__.register("onlineChatPopup",n)}();

},{"../../services/chat/chatStaticService":7,"./chatWorker":3,"./draggable":4}],6:[function(require,module,exports){
module.exports={
  "brokenTTL": 60000,
  "suppliers": {
    "prop": "suppliers",
    "url": "https://chat-basket-01.wb.ru/vol0/api/suppliers.json",
    "key": "chat-suppliers-static",
    "ttl": 3600000,
    "maxSize": 10000,
    "version": 1
  },
  "shards": {
    "url": "https://chat-basket-01.wb.ru/vol0/api/shards/shard.json",
    "key": "chat-shards-static",
    "ttl": 43200000,
    "version": 1
  }
}
},{}],7:[function(require,module,exports){
"use strict";const options=require("./chatStaticOptions.json");function getFromStatic(t){return fetch(t).then(t=>t.ok?t.json():{broken:!0}).catch(t=>({broken:!0}))}function getFromStorage({key:t,version:o}){var n;const e=localStorage.getObject(t);return!e||Date.now()>(null!==(n=e.t)&&void 0!==n?n:0)||e.v!=o?null:e}function saveToStorage(t,{key:o,ttl:n,version:e}){const a=Object.assign({t:Date.now()+n,v:e},t);localStorage.putObject(o,a)}async function getData({url:t,key:o,ttl:n,version:e,prop:a,maxSize:r}){try{let i=getFromStorage({key:o,version:e});if(null==i){var s;const{broken:c,...l}=await getFromStatic(t);r>0&&a&&(null===(s=l[a])||void 0===s?void 0:s.length)>r&&(console.warn("[CHAT STATIC WARNING]:","too much data to save, taking only",r,a),l[a]=l[a].slice(0,r)),saveToStorage(l,{key:o,version:e,ttl:c?options.ttlBroken:n}),i=l}return i}catch(t){return console.error("[CHAT STATIC ERROR]:",t),null}}let ChatStaticData=function(){function t(){}return t.suppliers=async function(){const{suppliers:t}=await getData(options.suppliers)||{suppliers:[]};return t||[]},t.shards=async function(){const{shards:t}=await getData(options.shards)||{shards:[]};return t||[]},t}();module.exports=ChatStaticData;

},{"./chatStaticOptions.json":6}],8:[function(require,module,exports){
"use strict";let SellersChatService=function(){function e(){this.baseUrl="https://chat.wildberries.ru/api/sellers-chat-1/v1/"}var t=e.prototype;return t.getChats=function(){return this._signedFetch("client/chats",null,{method:"GET"})},t.getEvents=function({lastTime:e,delay:t}={},{signal:n}={}){const r={delay:t,lastTime:e,lp:!0};return this._signedFetch("client/events",r,{signal:n})},t.sendEvent=function({chatId:e,sellerId:t,sellerName:n,text:r,attachments:s,sign:i,sender:a}){const o={eventType:"message",clientCreatedAt:Date.now(),sign:i,message:{actionType:"create",text:r},recipients:[{id:t.toString(),name:n,type:"seller"}],sender:a};return s&&(o.message.attachments=s),e?o.chatID=e:o.isNewChat=!0,this._signedFetch("client/send",o).then(e=>(e.event=o,e))},t.sendFile=function(e){const t=new FormData;t.append("file",e);const n=new Headers;return WbSpaModel.prototype.$wbxHttpClient.jwt&&n.set("Authorization",`Bearer ${WbSpaModel.prototype.$wbxHttpClient.jwt}`),fetch(this.baseUrl+"client/upload",{method:"POST",processData:!1,body:t,headers:n,credentials:"include",cache:"no-cache"}).then(e=>{if(e.ok)return e.json();throw new Error("Ошибка при отправке файла")})},t._signedFetch=async function(e,t,n={}){const r=t?JSON.stringify(t):null,s=new Headers;WbSpaModel.prototype.$wbxHttpClient.jwt&&s.set("Authorization",`Bearer ${WbSpaModel.prototype.$wbxHttpClient.jwt}`);const i=await fetch(this.baseUrl+e,Object.assign({method:"POST",body:r,headers:s,credentials:"include"},n));if(!i.ok){const e=await i.text();if(e.indexOf("ChatID is empty or not exist")>0)return{tryAsNew:!0};if(e.indexOf("Invalid signature")>0)return{invalidSignature:!0};throw new Error("Ошибка запроса")}return i.json()},t._signSha512=async function(e){const t=await crypto.subtle.digest("SHA-512",new TextEncoder("utf-8").encode(e));return new Uint8Array(t).reduce((e,t)=>e+t.toString(16).padStart(2,"0"),"")},e}();module.exports=SellersChatService;

},{}]},{},[5]);
