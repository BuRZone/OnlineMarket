(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function _defineProperties(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(t,e){if("object"!=typeof t||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}!function(){let t=function(){function t(t,e){this.parentId=t,this.nmId=e,this.isReady=!1,this.hideChart=!0,this.marker=null,this.onColorChanged=this.onColorChanged.bind(this)}var e=t.prototype;return e.init=function(){return this._bindEvents(),this},e.destroy=function(){this._unbindEvents()},e.onColorChanged=async function(t){var e,r;const{isDetailsLoaded:i,sourceId:n,sourceNmId:o,selectedNomenclature:s}=t.detail;if(n!=this.parentId||o!=this.nmId)return;if(this.nmId===s.nmId&&i)return;this.nmId=s.nmId,null===(e=this.marker)||void 0===e||e.dispatchEvent(new CustomEvent("Unshown")),null===(r=this.marker)||void 0===r||r.remove();const a=await this.$services.productCard.loadPriceHistory(this.nmId);this.showChartAsync(a,{currentPrice:s.price.salePrice,logisticsCost:s.price.logisticsCost})},e.renderChartAsync=async function(t){try{if(null==t)return;const e="classList"in SVGElement.prototype?Promise.resolve():this.$moduleLoader.loadModuleAsync("svgElementClassListPolyfill",!0);await e;const r=this._buildPoints(t);this.settings=this._getSettings(r),this.charPoint=this._createCharPoints(r,this.settings),this.dashedVerticalBarsCoords=this._createDashedBars(),this.chartPath=this._buildCharPath(),$.observable(this).setProperty({isReady:!0})}catch(t){console.error(t)}},e.showChartAsync=function(t,{currentPrice:e,logisticsCost:r}={}){this.marker=null;const i=r?parseInt(r):0;if($.observable(this).setProperty({isReady:!1}),this.chartEnable&&Array.isArray(t)&&(t.length>=2||e>0&&t.length>=1)){if(t.sort((t,e)=>t.dt-e.dt),t.forEach(t=>{var e;null!==(e=t.price)&&void 0!==e&&e.RUB&&(t.price.RUB="RUB"!==WbSpaModel.prototype.$user.getCurrency()?$.views.helpers.priceFromRub(t.price.RUB/100,!0)+i:Math.round(t.price.RUB/100+i))}),e>0){const r=(new Date).setHours(0,0,0,0)/1e3;t.push({dt:r,price:{RUB:e}})}this.renderChartAsync(t.slice(-26))}},e.showPricePoint=function(t){var e;"touchmove"==t.type&&t.preventDefault();const{width:r,left:i}=t.currentTarget.getBoundingClientRect(),n=this.canvasWidth/r,o=("touchmove"==t.type?t.originalEvent.targetTouches[0].pageX-i:t.offsetX)*n,s=this.charPoint.find((t,e,r)=>{const i=Math.max(0,o),n=0==e?t.xCoord:r[e-1].xCoord,s=t.xCoord,a=e==r.length-1?r[r.length-1].xCoord:r[e+1].xCoord;return n+(s-n)/2<=i&&i<=s+(a-s)/2});s&&(null==this.marker&&(this.marker=t.currentTarget.querySelector("circle")),this.currentChartPoint=s,this.marker.dispatchEvent(new CustomEvent("Unshown")),this.marker.setAttribute("cx",s.xCoord),this.marker.setAttribute("cy",s.yCoord),null===(e=this.marker.classList)||void 0===e||e.remove("hide"),this.marker.dispatchEvent(new CustomEvent("Shown")))},e.hidePricePoint=function(){var t,e;null===(t=this.marker)||void 0===t||null===(t=t.classList)||void 0===t||t.add("hide"),null===(e=this.marker)||void 0===e||e.dispatchEvent(new CustomEvent("Unshown"))},e.toggleChart=function(){var t;if("m"==wb.settings.displayMode)if(this.toggleProperty("hideChart"),this.hideChart)null===(t=this.marker)||void 0===t||t.dispatchEvent(new CustomEvent("Unshown"));else if(this.marker){var e;null===(e=this.marker.classList)||void 0===e||e.remove("hide"),this.marker.dispatchEvent(new CustomEvent("Shown"))}},e._buildPoints=function(t){return t.map(t=>({dt:t.dt,price:t.price.RUB}))},e._getSettings=function(t){const e=t.reduce((t,e)=>(e.price<t.min&&(t.min=e.price),e.price>t.max&&(t.max=e.price),t),{min:1/0,max:-1/0}),r=e.max-e.min,i=t[t.length-1].dt-t[0].dt,n=r/.6,o=n>0?this.canvasHeigth/n:.01,s=this.canvasWidth/i,[{price:a},{price:h}]=t.slice(-2);return{xAxisCoef:s,yAxisCoef:o,medianPrice:(e.max+e.min)/2,startDate:t[0].dt,lastDate:t[t.length-1].dt,minPrice:e.min,maxPrice:e.max,periodDelta:Math.abs(a-h),periodTrend:Math.sign(h-a)}},e._createCharPoints=function(t,e){const r=t.map(t=>{return{xCoord:(t.dt-e.startDate)*e.xAxisCoef,yCoord:this.canvasHeigth*(1-.8*t.price/e.maxPrice),startDate:new Date(1e3*t.dt),price:t.price}});for(let t=0;t<r.length-1;t++){const e=r[t],i=r[t+1],n={xCoord:e.xCoord+.25*(i.xCoord-e.xCoord),yCoord:e.yCoord},o={xCoord:e.xCoord+.75*(i.xCoord-e.xCoord),yCoord:i.yCoord};e.bezierPoint=[n,o],i.previous=e,e.next=i}return r},e._createDashedBars=function(){const t=[{xCoord:1,yCoord:this.charPoint[0].yCoord}];return t.push({xCoord:this.canvasWidth-1,yCoord:this.charPoint[this.charPoint.length-1].yCoord}),t},e._bezierCoord=function(t,e,r,i,n){const o=1-t;return o**3*e+3*o**2*t*r+3*o*t**2*i+t**3*n},e._buildCharPath=function(){const t=[];return this.charPoint.forEach((e,r)=>{0==r?t.push(`M ${e.xCoord} ${e.yCoord} C ${e.bezierPoint[0].xCoord} ${e.bezierPoint[0].yCoord}, ${e.bezierPoint[1].xCoord} ${e.bezierPoint[1].yCoord}`):r==this.charPoint.length-1?t.push(`${e.xCoord} ${e.yCoord}`):t.push(`${e.xCoord} ${e.yCoord}, ${e.bezierPoint[0].xCoord} ${e.bezierPoint[0].yCoord}, ${e.bezierPoint[1].xCoord} ${e.bezierPoint[1].yCoord}`)}),t.join(", ")},e._bindEvents=function(){this.$eventBus.addEventListener("ProductColorChanged",this.onColorChanged),this.$eventBus.addEventListener("ProductChanged",this.onColorChanged)},e._unbindEvents=function(){this.$eventBus.removeEventListener("ProductColorChanged",this.onColorChanged),this.$eventBus.removeEventListener("ProductChanged",this.onColorChanged)},_createClass(t,[{key:"template",get:function(){return t.template}},{key:"chartEnable",get:function(){var t,e;return null!==(t=null===(e=wb.global.settings)||void 0===e||null===(e=e.switches)||void 0===e?void 0:e.enablePriceHistoryChart)&&void 0!==t&&t}},{key:"canvasWidth",get:function(){return 1200}},{key:"canvasHeigth",get:function(){return this.$isDesktop?156:330}},{key:"minPrice",get:function(){return this.settings.minPrice}},{key:"maxPrice",get:function(){return this.settings.maxPrice}},{key:"periodChange",get:function(){return this.settings.periodDelta}},{key:"periodTrend",get:function(){return this.settings.periodTrend}},{key:"startDate",get:function(){const t=new Date(1e3*this.settings.startDate);return t.setDate(t.getDate()-7),t}},{key:"lastDate",get:function(){return new Date(1e3*this.settings.lastDate)}},{key:"currentPeriod",get:function(){const t=this;return{get startDate(){var e;let r=null===(e=t.currentChartPoint.previous)||void 0===e?void 0:e.startDate;return r||(r=new Date(+t.currentChartPoint.startDate)).setDate(t.currentChartPoint.startDate.getDate()-7),r},get lastDate(){return t.currentChartPoint.startDate},get price(){return t.currentChartPoint.price}}}}]),t}();window.__spaModuleManager__.register("priceHistoryChart",t)}();

},{}]},{},[1]);
