(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function _defineProperties(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,_toPropertyKey(s.key),s)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:String(t)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var s=i.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}!function(){let e=function(){function e(e,t){this.parentId=e,this.nmId=t.nmId,this.nmSizes=t.sizes,this.enabledForRegion=t.enabledForRegion,this.allSizesSoldOut=t.allSizesSoldOut,this.selectedSize=t.selectedSize,this.deliveryHours=t.deliveryHours,this.fastestStore=t.fastestStore,this.isImport=t.isImport,this.onSizeUpdated=this.onSizeUpdated.bind(this),this.onColorChanged=this.onColorChanged.bind(this)}var t=e.prototype;return t.init=function(){return this._bindEvents(),this},t.destroy=function(){return this._unbindEvents(),this},t.onSizeUpdated=function(e){const{nmId:t,selectedSize:i}=e.detail;this.nmId==t&&this.updateSize(i)},t.onColorChanged=function(e){const{sourceId:t,sourceNmId:i,selectedNomenclature:s}=e.detail;t==this.parentId&&i==this.nmId&&($.observable(this).setProperty({nmId:s.nmId,enabledForRegion:s.enabledForRegion,allSizesSoldOut:s.allSizesSoldOut,selectedSize:s.selectedSize,deliveryHours:s.deliveryHours,fastestStore:s.fastestStore,isImport:s.isImport}),this.nmSizes=s.sizes,s.isDetailsLoaded&&this.updateAll())},t.updateAll=async function(){var e;await this.updateSize(null===(e=this.selectedSize)||void 0===e?void 0:e.characteristicId),this._updateProductFlags(),this.updateExpressStore()},t.updateSize=async function(e){var t;let i=null;if(this.deliveryModelTask=new this.$helper.Deferred,this.enabledForRegion&&!this.allSizesSoldOut&&(null===(t=this.selectedSize)||void 0===t||!t.isSoldOut)){await this.$moduleLoader.loadServiceAsync("deliveryInfoService");const t=this._getStoresForSize(e),s=this._getFastestStoreFromProduct(e),r=this._getDeliveryDateFromProduct(e),o=await this.$services.deliveryInfoService.getDeliveryInfoAsync(e).catch(()=>({delivery:{stores:{computedDelCostStores:[],cargo:this.$services.storeService.cargoStores.map(e=>e.id)},times:[{storeId:s,deliveryOption:"самовывоз",isSupposedDate:!0,extraDays:0,inDays:0,closestDeliveryDate:new Date(Date.now()+60*(r||0)*60*1e3)}]}}));this.deliveryInfo=o,i=this.$services.deliveryInfoService.getDeliveryModel(o,t,s,r,null,this.isImport)}this.deliveryModelTask.resolve(i),$.observable(this).setProperty({deliveryInfoModel:i})},t._updateProductFlags=function(){var e,t,i;null!==(e=this.deliveryInfo)&&void 0!==e&&e.delivery&&this.deliveryInfoModel&&$.observable(this.deliveryInfoModel).setProperty({isComputedDeliveryCost:null===(t=this.nmSizes)||void 0===t?void 0:t.some(e=>{var t;return null===(t=e.storeIds)||void 0===t?void 0:t.some(e=>this.deliveryInfo.delivery.stores.computedDelCostStores.includes(e))}),isCargo:null===(i=this.nmSizes)||void 0===i?void 0:i.some(e=>{var t;return null===(t=e.storeIds)||void 0===t?void 0:t.some(e=>this.deliveryInfo.delivery.stores.cargo.includes(e))})})},t.updateExpressStore=async function(){var e;await this.$moduleLoader.loadServiceAsync("deliveryInfoService");const t=await this.$services.deliveryInfoService.getExpressStoreAsync();Object.values(null!==(e=this.nmSizes)&&void 0!==e?e:[]).forEach(e=>{var i,s;$.observable(e).setProperty({isExpressDelivery:null!==(i=null==e||null===(s=e.storeIds)||void 0===s?void 0:s.some(e=>t.store==e))&&void 0!==i&&i})})},t.getByChrtId=function(e){const t=this._getStoresForSize(e),i=this._getFastestStoreFromProduct(e),s=this._getDeliveryDateFromProduct(e);return this.$services.deliveryInfoService.getDeliveryModel(this.deliveryInfo,t,i,s,null,this.isImport)},t._bindEvents=function(){this.$eventBus.addEventListener("ProductSizeUpdated",this.onSizeUpdated),this.$eventBus.addEventListener("ProductColorChanged",this.onColorChanged),this.$eventBus.addEventListener("ProductChanged",this.onColorChanged)},t._unbindEvents=function(){this.$eventBus.removeEventListener("ProductSizeUpdated",this.onSizeUpdated),this.$eventBus.removeEventListener("ProductColorChanged",this.onColorChanged),this.$eventBus.removeEventListener("ProductChanged",this.onColorChanged)},t._getStoresForSize=function(e){return e?this.nmSizes.slice().find(t=>t.characteristicId===e).storeIds:Object.keys(this.nmSizes.slice().reduce((e,t)=>(t.isSoldOut||t.storeIds.forEach(t=>e[t]=!0),e),{}))},t._getDeliveryDateFromProduct=function(e){var t;if(null!==(t=wb.global.settings.switches)&&void 0!==t&&t.catalogShowDeliveryDate)return e?this.nmSizes.slice().find(t=>t.characteristicId===e).deliveryHours:this.deliveryHours},t._getFastestStoreFromProduct=function(e){return e?this.nmSizes.slice().find(t=>t.characteristicId===e).fastestStore:this.fastestStore},_createClass(e,[{key:"template",get:function(){return e.template}}]),e}();window.__spaModuleManager__.register("deliveryInfoHelper",e)}();

},{}]},{},[1]);
